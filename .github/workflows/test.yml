name: FilaOps CI/CD - Tests

on:
  push:
    branches: [ main, develop, feat/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Backend Tests
  backend-tests:
    name: Backend Unit & Integration Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: filaops
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: filaops_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install Python dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql+psycopg://filaops:testpassword@localhost:5432/filaops_test
        run: |
          cd backend
          alembic upgrade head

      - name: Run backend tests with coverage
        env:
          DATABASE_URL: postgresql+psycopg://filaops:testpassword@localhost:5432/filaops_test
          DB_USER: filaops
          DB_PASSWORD: testpassword
          DB_HOST: localhost
          DB_PORT: "5432"
          TEST_DB_NAME: filaops_test
          REDIS_URL: redis://localhost:6379
          TESTING: true
        run: |
          cd backend
          pytest tests/ -v --tb=short --cov=app --cov-report=xml --cov-report=term

      - name: Report coverage (informational)
        run: |
          cd backend
          coverage report || true
          echo "Coverage reported - not enforcing threshold during active development"

      - name: Run backend linting
        run: |
          cd backend
          pip install ruff
          ruff check app/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: backend/coverage.xml
          flags: backend
          name: backend-coverage

  # Frontend Tests
  frontend-tests:
    name: Frontend Component Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run frontend linting
        run: |
          cd frontend
          npm run lint -- --max-warnings 50 || echo "Lint warnings present - not blocking during active development"

      - name: Run frontend component tests (if exists)
        run: |
          cd frontend
          # npm test -- --coverage || echo "No component tests yet"

  # E2E Tests - Disabled during active development
  e2e-tests:
    name: Playwright E2E Tests
    if: false  # Disabled - run manually via workflow_dispatch
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: filaops
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: filaops_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Install Playwright browsers
        run: |
          cd frontend
          npx playwright install --with-deps chromium

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql+psycopg://filaops:testpassword@localhost:5432/filaops_test
        run: |
          cd backend
          alembic upgrade head

      - name: Seed test database
        env:
          DATABASE_URL: postgresql+psycopg://filaops:testpassword@localhost:5432/filaops_test
        run: |
          cd backend
          python scripts/seed_test_data.py || echo "No seed script, skipping"

      - name: Start backend server
        env:
          DATABASE_URL: postgresql+psycopg://filaops:testpassword@localhost:5432/filaops_test
          TESTING: true
        run: |
          cd backend
          uvicorn app.main:app --host 0.0.0.0 --port 8001 &
          sleep 5

      - name: Start frontend dev server
        run: |
          cd frontend
          npm run dev &
          sleep 10

      - name: Wait for servers to be ready
        run: |
          npx wait-on http://localhost:5174 http://localhost:8001/api/v1/health --timeout 60000

      - name: Run Playwright E2E tests
        env:
          BASE_URL: http://localhost:5174
        run: |
          cd frontend
          npx playwright test --reporter=html,github

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results
          path: frontend/test-results/
          retention-days: 7

  # Sprint 1 Specific Tests - Disabled during active development
  sprint1-tests:
    name: Sprint 1 Validation Tests
    if: false  # Disabled - run manually via workflow_dispatch
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: filaops
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: filaops_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend && pip install -r requirements.txt
          cd ../frontend && npm ci

      - name: Install Playwright
        run: |
          cd frontend
          npx playwright install --with-deps chromium

      - name: Run migrations
        env:
          DATABASE_URL: postgresql+psycopg://filaops:testpassword@localhost:5432/filaops_test
        run: |
          cd backend
          alembic upgrade head

      - name: Start servers
        env:
          DATABASE_URL: postgresql+psycopg://filaops:testpassword@localhost:5432/filaops_test
        run: |
          cd backend && uvicorn app.main:app --host 0.0.0.0 --port 8001 &
          cd frontend && npm run dev &
          sleep 15

      - name: Run Sprint 1 Performance Tests
        run: |
          cd frontend
          npx playwright test sprint1-performance --reporter=line,github

      - name: Run Sprint 1 Validation Tests
        run: |
          cd frontend
          npx playwright test sprint1-validation --reporter=line,github

      - name: Run Sprint 1 API Tests
        run: |
          cd frontend
          npx playwright test sprint1-api --reporter=line,github

      - name: Run Sprint 1 Accessibility Tests
        run: |
          cd frontend
          npx playwright test sprint1-accessibility --reporter=line,github || echo "Accessibility tests may have failures - tracking progress"

      - name: Generate Sprint 1 Test Report
        if: always()
        run: |
          echo "## Sprint 1 Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Sprint 1 tests completed. Check artifacts for detailed results." >> $GITHUB_STEP_SUMMARY

  # Build Validation
  build-check:
    name: Build Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Check build size
        run: |
          cd frontend
          du -sh dist/
          echo "Build completed successfully"

  # Status Badge Update
  update-status:
    name: Update Status Badge
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests, sprint1-tests, build-check]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create status badge
        run: |
          echo "All tests completed. See individual job results above."
